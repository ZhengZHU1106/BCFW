TODO 行动文档

### **第一阶段：环境与核心配置** ✅ **已完成**

* [x] 全局安装 `ganache`: `npm install -g ganache`。
* [x] 确定一个12词的**项目助记词**，并写入`README.md`。
  * **实现说明**: 生成了有效的BIP39助记词：`bulk tonight audit hover toddler orange boost twenty biology flower govern soldier`
  * **原因**: 原助记词不符合BIP39标准，重新生成了有效助记词
* [x] 在`package.json`中或创建一个`start-chain.sh`脚本，配置好启动Ganache的最终命令:
  * **实现说明**: 创建了多种启动方式
    - `npm run start-chain` - CLI方式启动
    - `start-dev.sh` - 一键开发环境脚本  
    - `npm run start-chain-desktop` - 桌面端配置说明
  * **改进**: 提供了CLI和桌面端两种方式，增强了灵活性
* [x] 初始化FastAPI后端项目和`requirements.txt`。
* [x] 初始化Vue/React前端项目。
  * **实现说明**: 创建了基础Vue项目结构，待第二阶段后实际开发
* [x] 将所有预备资产（模型包、数据文件）放入后端的`assets`目录下。
  * **实现说明**: 
    - 模型文件放入 `backend/assets/model_package/`
    - 数据文件放入 `backend/assets/data/`
    - 创建了完整的配置管理 `backend/config.py`

**第一阶段额外完成项**:
* [x] 创建完整的测试框架 (`test/` 目录)
* [x] 实现项目验证脚本 (`npm run test`)
* [x] 优化项目文档结构
* [x] 创建开发环境自动化脚本

### **第二阶段：后端开发** ✅ **已完成**

* [x] 配置FastAPI，使其`Web3`实例连接到本地Ganache (`http://127.0.0.1:8545`)。
  * **实现说明**: 完整的Web3Manager集成，支持确定性账户生成和余额管理
* [x] 从Ganache启动日志中复制**固定的**Manager和金库账户的地址与私钥，作为后端的配置项。
  * **实现说明**: 使用BIP39助记词生成确定性账户，无需复制地址
* [x] **核心**: 创建`ai_module.py`，编写逻辑在应用启动时**加载预打包的模型文件**。
  * **实现说明**: 完整的model_loader.py，支持真实Ensemble_Hybrid模型加载
  * **改进**: 解决了sklearn版本兼容性问题，使用joblib替代pickle
* [x] 在后端启动时，**加载预抽样的攻击数据**`inference_data.pt`。
  * **实现说明**: 成功加载230个真实攻击样本，支持随机采样模拟
* [x] 实现数据库模型 (`proposals`, `execution_logs`)及初始化。
  * **实现说明**: SQLite数据库，包含ThreatDetectionLog, Proposal, ExecutionLog模型
* [x] 开发**"模拟攻击"API**并实现完整的**分级响应逻辑**。
  * **实现说明**: POST /api/attack/simulate，支持4级响应逻辑
* [x] 开发**手动/自动提案**的相关API。
  * **实现说明**: 自动提案创建和手动提案创建API
* [x] 开发**提案签名**API。
  * **实现说明**: POST /api/proposals/{id}/sign，支持2/3多重签名
* [x] 开发**"提案执行与激励"**逻辑 (从金库转账ETH)。
  * **实现说明**: 完整的奖励系统，0.01 ETH奖励给最终签名者

**第二阶段额外完成项**:
* [x] 完整的API端点测试套件 (`test_phase2_fixed.sh`)
* [x] 系统状态监控API (`/api/system/status`)  
* [x] 审计日志API (`/api/logs/detections`, `/api/logs/executions`)
* [x] 奖励发送测试API (`/api/test/reward`)
* [x] 修复预处理器版本兼容性问题
* [x] 优化提案排序和ID获取逻辑

### **第三阶段：前端可视化开发** ✅ **已完成**

* [x] 实现无状态的"角色切换器"。
  * **实现说明**: 创建RoleSwitch组件，支持Operator/Manager角色切换，使用localStorage持久化
* [x] 开发**账户信息看板**组件，轮询后端API以展示余额和持续增长的区块高度。
  * **实现说明**: Dashboard页面实现完整的账户信息展示，5秒自动刷新系统状态
* [x] 开发**账户列表模拟**组件 (纯前端功能)。
  * **改进**: 不仅是纯前端功能，实现了真实的Web3账户创建和Treasury转账功能
* [x] 开发威胁告警、提案卡片、历史记录等核心可视化组件。
  * **实现说明**: 完整的威胁检测页面、提案管理界面、历史记录展示
* [x] 联调所有API，完成端到端流程。
  * **实现说明**: 所有API联调成功，端到端流程完整可用

**第三阶段额外完成项**:
* [x] Vue 3 + Vite现代化前端框架搭建
* [x] 完整的组件化架构设计
* [x] 响应式UI设计，适配不同屏幕尺寸
* [x] 真实的Web3账户创建和资金管理功能
* [x] 实时数据更新和轮询机制
* [x] 详细的日志详情模态框组件
* [x] CSV数据导出功能
* [x] 完善的错误处理和用户体验

### **第四阶段：集成测试与交付** ✅ **已完成**

* [x] 进行端到端手动测试，确保所有业务逻辑正确。
  * **实现说明**: test_phase2_fixed.sh测试脚本验证所有功能正常
* [x] 编写`README.md`，清晰说明如何安装依赖、如何启动Ganache、后端和前端，以及如何进行演示。
  * **实现说明**: 完整的README文档，包含Phase 3启动指南
* [x] 清理代码，准备最终交付。
  * **实现说明**: 创建start-phase3.sh一键启动脚本，完善项目文档

**第四阶段额外完成项**:
* [x] 创建完整的前端项目文档
* [x] 实现一键启动脚本 (start-phase3.sh)
* [x] 完整的开发和部署说明文档
* [x] 系统演示准备完成

### **第五阶段：界面国际化** ✅ **已完成**

* [x] 前端界面完全英文化
  * **实现说明**: 所有Vue组件中的中文文本转换为英文
* [x] 组件文本更新
  * **实现说明**: 更新AccountList, ProposalCard, ThreatAlert, LogDetailsModal, History组件
* [x] 状态映射英文化
  * **实现说明**: 所有状态、级别、操作类型的中英文映射完成
* [x] 错误信息英文化
  * **实现说明**: 所有alert和console.error信息转换为英文
* [x] 文档更新
  * **实现说明**: 更新CLAUDE.md记录当前状态和下一步计划

### **第六阶段：自定义MultiSig智能合约集成** ✅ **已完成**

* [x] **智能合约开发**
  * **实现说明**: 创建 `MultiSigProposal.sol` 智能合约，支持2/3多重签名
* [x] **合约部署和配置**
  * **实现说明**: 使用 `deploy_multisig_simple.js` 部署合约到Ganache
  * **合约地址**: `0x5FbDB2315678afecb367f032d93F642f64180aa3`
* [x] **Python集成模块**
  * **实现说明**: 创建 `multisig_contract.py` 实现后端与合约交互
* [x] **提案创建升级**
  * **实现说明**: AI检测自动创建链上MultiSig提案，替代传统数据库模式
* [x] **签名流程优化**
  * **实现说明**: Manager签名直接与智能合约交互，支持自动执行
* [x] **奖励自动化**
  * **实现说明**: 合约自动发送ETH奖励给最终签名者
* [x] **事件日志集成**
  * **实现说明**: 完整的链上审计日志，通过智能合约事件实现

**第六阶段额外完成项**:
* [x] 合约接口文档和配置文件 (`multisig_interface.json`)
* [x] 部署脚本自动化 (`deploy_multisig.js`, `deploy_multisig_simple.js`)
* [x] 向后兼容的双重签名系统（数据库+合约）
* [x] 完整的智能合约测试和验证

### **第七阶段：奖金池机制实现** ✅ **Phase A完成 (2-3天)**

**解决博弈论问题:** ✅
- [x] 当前"最终签名者获奖"机制导致Manager延迟签名等待成为最后一个 - 已解决
- [x] 实现基于贡献度的奖金池分配系统 - 已实现
- [x] 建立公平的长期激励机制 - 已建立

**Phase 7.1: 智能合约奖金池系统** ✅
- [x] 修改MultiSigProposal.sol添加奖金池管理功能
- [x] 实现贡献度记录结构(签名次数、响应时间、质量评分)
- [x] 添加奖金池充值、提取和分配函数
- [x] 设计自动奖励分配机制（改为提案执行时触发）

**Phase 7.2: 后端奖金池集成** ✅
- [x] 更新Web3Manager支持奖金池操作
- [x] 修改Services添加贡献度统计业务逻辑
- [x] 扩展数据库模型添加奖金池和贡献记录表
- [x] 实现自动奖励分配任务（提案执行完成时触发）

**Phase 7.3: 前端奖金池界面** ✅
- [x] 更新Dashboard显示奖金池当前余额和统计
- [x] 添加Manager贡献度排行榜和历史记录
- [x] 实现奖金池充值功能界面
- [x] 显示自动分配提示和算法说明

**Phase A完成额外项：**
- [x] 创建完整的奖金池算法说明文档（奖金池算法说明.md）
- [x] 实现0-100分质量评分算法（响应速度60% + 活跃度40%）
- [x] 实现0-100分贡献度计算算法（签名次数50% + 质量评分50%）
- [x] 系统启动时自动初始化100 ETH奖金池
- [x] 移除手动分配功能，保留充值功能

**Phase A问题修复项：**
- [x] 修复奖金池初始化和状态持久化问题
- [x] 修复Manager贡献度更新和状态保存问题  
- [x] 修复自动分配机制触发和返回值处理问题
- [x] 添加状态文件管理（reward_pool_state.json, contributions_state.json）
- [x] 完善自动分配测试API和错误处理

### **第八阶段：合约层角色权限分离** ✅ **Phase 8完成 (4-5天)**

**真正去中心化权限控制:**
- [x] 将角色验证从后端移至智能合约层
- [x] 实现合约级别的权限分离和访问控制
- [x] 整合原Phase 5的固定账户架构设计

**Phase 8.1: 智能合约角色系统重构** ✅
- [x] 重新设计MultiSigProposal.sol的访问控制系统
- [x] 添加isManager和isOperator映射及相应修饰符
- [x] 分离createProposal(onlyOperator)和signProposal(onlyManager)权限
- [x] 实现合约层面的角色管理函数

**Phase 8.2: 合约重新部署和配置** ✅
- [x] 创建新的部署脚本支持角色初始化
- [x] 重新部署智能合约并设置Manager和Operator角色
- [x] 更新合约配置文件和ABI接口
- [x] 迁移现有提案数据到新合约

**Phase 8.3: 后端权限简化** ✅
- [x] 移除后端API的复杂角色验证逻辑
- [x] 更新所有API端点信任合约权限验证
- [x] 修改multisig_contract.py适配新的角色系统
- [x] 简化Services中的权限判断代码

**Phase 8.4: 前端角色特定界面** ✅
- [x] 实现固定10账户结构(Manager_0-2, Treasury, Operator_0-5)
- [x] 基于当前账户自动识别和显示对应角色界面
- [x] Manager界面仅显示签署和监控功能
- [x] Operator界面仅显示创建和检测功能

**Phase 8额外完成项：**
- [x] 修复前后端响应级别映射不一致问题
- [x] 修复威胁类型显示问题（显示真实攻击类型而非错误预测）
- [x] 修复创建提案时缺少角色信息的问题
- [x] 修复提案数据结构中signed_by字段处理问题
- [x] 完整测试系统功能和端到端流程

### **第九阶段：AI模型预测准确性修复** ⚠️ **Phase C (紧急修复)**

**问题诊断:**
- ✅ 确认模型训练本身成功（99.62%准确率）
- ✅ 识别问题根源：模型架构重建不完整导致权重加载失败
- ✅ 发现模型使用随机权重预测，导致所有攻击被误判为"Benign"

**Phase C.1: 模型架构完整性修复**
- [ ] 将training.ipynb中的完整Ensemble_Hybrid架构复制到model_loader.py
- [ ] 确保所有组件完全一致：ResidualBlock、SelfAttentionBranch、FeatureInteractionBranch
- [ ] 修复参数数量匹配（训练时355,494参数）
- [ ] 验证模型结构与训练时一致

**Phase C.2: 权重加载机制修复**
- [ ] 修复state_dict键名匹配问题
- [ ] 实现权重加载验证机制
- [ ] 添加权重加载成功/失败的明确日志
- [ ] 确保模型权重正确加载而非使用随机初始化

**Phase C.3: 预测准确性验证**
- [ ] 创建模型预测准确性测试脚本
- [ ] 验证模型能正确预测各种攻击类型
- [ ] 确保置信度分布合理（不再全部预测为Benign）
- [ ] 测试端到端预测流程

**Phase C.4: 前端显示优化**
- [ ] 验证前端能正确显示各种攻击类型
- [ ] 确保威胁类型显示准确（显示true_label而非错误的predicted_class）
- [ ] 测试攻击模拟和威胁记录的正确性

**预期结果:**
- 模型预测准确率恢复到99%+
- 正确识别各种攻击类型（DDoS、DoS GoldenEye、PortScan、SSH-Patator等）
- 置信度分布合理，不再全部预测为"Benign"
- 前端正确显示真实攻击类型

### **第十阶段：网络可视化和动态节点管理** ✅ **已完成 (3-4天)**

**创建区块链网络模拟器般的可视化体验:**
- [x] 交互式网络拓扑可视化页面 ✅
- [x] 真实的节点创建和删除管理 ✅
- [x] 多种网络布局和攻击流程可视化 ✅

**Phase 10.1: 网络可视化架构** ✅ **已完成**
- [x] 创建基于HTML5 Canvas的网络渲染引擎
- [x] 实现Star、Grid、Circle、Random四种布局算法
- [x] 设计节点交互系统（点击、悬停、详情显示）
- [x] 实现连接线可视化和网络状态指示

**Phase 10.2: 节点管理系统** ✅ **已完成**
- [x] 开发真实节点创建API和前端界面
- [x] 实现安全节点删除机制（保护核心节点）
- [x] 添加节点详情查看和角色特定信息显示
- [x] 集成余额自动回收和Treasury管理

**Phase 10.3: 攻击流程可视化** ✅ **已完成**
- [x] 实现威胁检测→提案创建→签名→执行的可视化流程
- [x] 添加动画效果展示攻击传播路径
- [x] 创建流程步骤面板显示实时进度
- [x] 集成真实API数据和状态更新

**Phase 10.4: 实时更新优化** ✅ **已完成**
- [x] 修复前端节点数量统计更新问题
- [x] 实现Canvas响应式更新和重新渲染
- [x] 优化Vue响应式系统和数据绑定
- [x] 添加强制刷新机制和状态同步

**第十阶段额外完成项：**
- [x] 创建NetworkCanvas.vue专业Canvas组件
- [x] 实现NodeDetail.vue详情模态框组件
- [x] 添加节点类型图例和网络状态指示器
- [x] 完善节点创建表单验证和错误处理
- [x] 实现节点删除确认对话框和安全检查
- [x] 优化网络布局算法和视觉效果

### **第十一阶段：MetaMask Web3集成** **Phase 9 (7-10天)**

**实现真正的去中心化用户体验:**
- [ ] 用户直接控制私钥和交易签名
- [ ] 前端直接与智能合约交互
- [ ] 移除后端代理的中心化控制

**Phase 9.1: 前端Web3架构重构**
- [ ] 实现MetaMask连接和账户管理组件
- [ ] 重构Web3集成支持用户钱包直接交互
- [ ] 添加钱包状态管理和账户切换监听
- [ ] 设计交易确认和状态反馈界面

**Phase 9.2: 智能合约兼容性确保**
- [ ] 验证合约与外部钱包交互的兼容性
- [ ] 优化Gas费估算和交易参数设置
- [ ] 实现合约事件监听和状态同步
- [ ] 添加交易失败处理和重试机制

**Phase 9.3: 后端签名验证系统**
- [ ] 更新API支持MetaMask签名验证
- [ ] 实现链下签名验证和消息认证
- [ ] 添加用户身份验证和会话管理
- [ ] 保持传统模式的向后兼容性

**Phase 9.4: 用户体验优化**
- [ ] 设计直观的钱包连接引导流程
- [ ] 实现网络切换提示和错误处理
- [ ] 添加交易历史和状态追踪
- [ ] 提供MetaMask安装和配置指南

### **第十二阶段：API标准化和系统优化** ✅ **Phase 9完成 (1天)**

**实现现代化API架构和前端连接优化:**
- [x] 统一API响应格式和异常处理机制 ✅
- [x] 修复前端连接问题和数据同步机制 ✅
- [x] 完善系统启动脚本和状态监控 ✅

**Phase 12.1: API响应标准化** ✅
- [x] 创建Pydantic标准化响应模型 (`backend/api/schemas.py`)
- [x] 实现统一异常处理机制 (`backend/api/exceptions.py`) 
- [x] 创建响应工具函数 (`backend/api/responses.py`)
- [x] 规范化所有API端点使用标准格式

**Phase 12.2: API版本控制** ✅
- [x] 所有API端点添加 `/api/v1/` 版本前缀
- [x] 更新API文档和端点描述
- [x] 添加详细的请求/响应验证
- [x] 实现向后兼容的版本管理

**Phase 12.3: 前端连接修复** ✅
- [x] 修复API路径重复问题 (`/api/api/v1` → `/api/v1`)
- [x] 更新前端数据映射 (`blockchain.connected` → `network.is_connected`)
- [x] 修复提案签名参数格式 (`managerIndex` → `manager_role`)
- [x] 统一前端API调用路径和参数

**Phase 12.4: 系统启动优化** ✅
- [x] 修复 `system.sh` 状态检测逻辑 (Ganache chainId检测)
- [x] 优化前端状态检测 (支持中文标题匹配)
- [x] 完善启动脚本错误处理和日志输出
- [x] 验证端到端系统启动和连接状态

**第十二阶段额外完成项：**
- [x] 清理临时日志文件和开发缓存
- [x] 优化错误处理和用户反馈机制
- [x] 验证所有API端点正常工作
- [x] 确认前端显示"Connected"状态

**数据同步机制最终决策：**
- [x] 评估WebSocket集成的必要性
- [x] 确定保持5秒轮询机制 (适合演示原型系统)
- [x] 避免过度工程化和不必要的复杂度

### **技术债务清理完成状态**
- [x] 修复提案签署API参数不匹配问题 ✅
- [x] 统一API响应格式和数据结构 ✅  
- [x] 完善错误处理和用户反馈机制 ✅
- [x] 修复前端连接和状态显示问题 ✅
- [x] 优化系统启动和监控脚本 ✅

### **系统当前状态** ✅
- **前端**: Connected状态正常显示，所有功能可用
- **后端**: API标准化完成，响应格式统一
- **区块链**: Ganache网络稳定运行，智能合约正常
- **启动脚本**: `system.sh` 脚本完全可用