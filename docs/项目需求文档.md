项目需求文档 

### 1. 项目概述

本项目旨在开发一个“区块链智能安防平台”的**演示原型**。其核心是利用AI模型自动检测网络攻击，并通过一个**模拟的**多重签名机制来对响应措施进行决策和审计。项目的最终目标是可视化地展示从威胁检测到决策，再到可信日志记录的全过程。

* **核心技术栈**: 本项目使用 **Ganache** 作为本地开发区块链模拟器。通过固定的**助记词 (Mnemonic)** 确保确定性的账户地址，并启用**定时出块 (`--blockTime`)** 模式以模拟持续运行的网络。
* **数据集来源**: 本项目使用的威胁检测数据源为 **CIC-IDS2017**，具体可参考：[https://www.kaggle.com/datasets/dhoogla/cicids2017](https://www.kaggle.com/datasets/dhoogla/cicids2017)

### 1.1. 预备资产

本项目基于一系列已准备好的核心资产进行开发。**开发过程中不涉及模型训练或数据生成，所有测试与模拟攻击均需使用已备好的数据。**
* **模型训练代码**: `training.ipynb`，详细说明了模型架构和训练流程。
* **模型文件包**: 一个包含 `model.pth`, `scaler.pkl`, `feature_selector.pkl`, `label_encoder.pkl` 等文件的完整模型部署包。
* **抽样数据脚本**: `抽样数据脚本.ipynb`，用于从CIC-IDS2017数据集中提取真实的攻击样本。
* **抽样攻击数据**: `inference_data.pt`，一个由上述脚本生成的、用于“模拟攻击”功能的真实数据文件。

### 2. 核心角色与账户设计

* **Ganache账户分配**:
    * **Manager 账户**: Ganache生成的前3个账户被指定为3个Manager的业务账户。
    * **系统金库账户**: Ganache生成的第4个账户被指定为系统金库，并拥有高额初始余额。
    * **挖矿账户**: **无需指定**。Ganache的定时出块机制会自动处理。
* **操作角色**:
    * **Operator (操作员)**: 系统的一线使用者。负责监控AI告警，并根据中低置信度的告警**手动发起“响应提案”**。
    * **Manager (管理员)**: 系统的高级决策者。负责审查提案并使用其账户进行签名批准。

### 3. 系统功能需求

| 模块 | 功能ID | 功能描述 | 备注 |
| :--- | :--- | :--- | :--- |
| **区块链模拟** | FR-1 | 系统使用 **Ganache** 提供一个稳定、即时的区块链环境。 | 移除了所有Geth和Docker依赖。 |
| | FR-2 | **网络活跃度**：通过两种方式展示网络是健康存活的。 | |
| | FR-2a | **基础活跃度**: 网络通过Ganache的定时出块功能，**每隔固定时间（如5秒）自动产生新区块**，体现在区块高度的稳定增长上。 | 网络的“心跳”。 |
| | FR-2b | **业务活跃度**: Manager和金库的账户余额**因激励机制而发生有意义的变化**。 | 网络的“事件”。 |
| **AI威胁检测** | FR-3 | 系统需集成预训练好的 `Ensemble_Hybrid` 模型文件包。 | 后端启动时加载所有模型文件。 |
| | FR-3a | **模型架构一致性**：部署时的模型架构必须与训练时完全一致，确保权重正确加载。 | **关键要求**：包括ResidualBlock、SelfAttentionBranch、FeatureInteractionBranch等所有组件。 |
| | FR-3b | **权重验证机制**：系统启动时必须验证模型权重是否正确加载，避免使用随机权重。 | 确保99.62%的训练准确率在部署时得到保持。 |
| | FR-4 | 前端提供一个"模拟攻击"按钮。点击后，后端从预加载的 `inference_data.pt` 文件中**随机抽取一条真实攻击样本**，并触发AI模型检测。 | |
| | FR-4a | **预测准确性**：模型应能正确识别各种攻击类型（DDoS、DoS GoldenEye、PortScan、SSH-Patator等），不应全部预测为"Benign"。 | **质量保证**：前端显示真实攻击类型，而非错误预测结果。 |
| **分级响应** | FR-5 | **分级响应决策逻辑**：AI检测后，系统根据预测结果的**置信度**执行不同操作。 | |
| | FR-5a | **高置信度 ( > 0.90 ) → 自动响应**: 系统将**自动“模拟”封锁**IP，并记录日志。 | |
| | FR-5b | **中高置信度 (0.80-0.90) → 自动发起提案**: 系统将**自动创建“响应提案”**，交由Manager审批。 | |
| | FR-5c | **中低置信度 (0.70-0.80) → 手动决策**: 系统仅在UI上产生告警，由**Operator决定是否手动发起提案**。 | |
| | FR-5d | **低置信度/良性 ( < 0.70 ) → 静默记录**: 系统在后台记录事件，不产生前端告警。 | |
| **多签提案系统**| FR-6 | **提案发起 (混合模式)**： | |
| | FR-6a | **自动发起**: 当满足FR-5b条件时，由系统自动创建提案。 | |
| | FR-6b | **手动发起**: 当满足FR-5c条件时，Operator可在UI上点击按钮，手动为该告警创建提案。 | |
| | FR-7 | Manager可以查看待处理的提案列表，并对提案进行签名批准。 | |
| | FR-8 | 提案需获得至少2/3（即2位）Manager的签名才能被批准。 | |
| | FR-9 | **激励机制**: 当一个提案被批准后，系统从**系统金库账户**向**完成最终签名（第2个签名）的Manager的账户**转移一笔固定的手续费（如0.01 ETH）作为奖励。 | 已优化为基于贡献度的奖金池分配机制 |
| | FR-9a| **奖金池机制**: 系统启动时自动初始化100 ETH奖金池，每次提案执行完成时自动按Manager贡献度分配1 ETH奖励。 | Phase A优化完成 |
| **模拟响应** | FR-10 | 提案被批准或AI自动响应后，系统**不与真实防火墙交互**。 | **核心简化！** |
| | FR-11| 系统通过在“执行日志”数据库表中插入一条详细记录来**“模拟”**封锁或解封操作。 | |
| **前端可视化**| FR-12| **账户信息看板**: 清晰地展示3个Manager账户和金库账户的**角色**、**地址**和**实时余额**。以及**当前区块高度**。 | “节点看板”正式更名为“账户看板”。 |
| | FR-12a| **账户列表模拟**: 在每个Manager卡片中，提供“添加/删除模拟账户”的UI功能。 | **此功能仅为前端视觉效果**，不与后端或区块链交互。 |
| | FR-13| **威胁告警可视化**：当“模拟攻击”后，在界面上高亮或用动画效果标记出受攻击的目标IP，并显示告警级别。 | |
| | FR-14| **多签流程可视化**：以卡片形式清晰展示每个提案的详情、签名状态和已签名的Manager列表。 | |
| | FR-15| **响应历史仪表盘**：以时间线或列表形式，清晰地展示“执行日志”中的所有历史操作记录。 | |
| | FR-16| **角色模拟切换器**：提供一个简单的下拉框或按钮，让演示者可以在前端轻松切换Operator和Manager的视图。 | |

### 4. 非功能性需求
* **一键启动**: 后端服务、前端服务和Ganache区块链模拟器应能通过简单的命令（如`npm start`或`docker-compose up`）全部启动。
* **演示友好**: 界面流程清晰，状态变化明确，便于向他人展示项目核心价值。
* **轻量化**: 最终方案不依赖Docker和Geth，资源占用极小。

---

## 5. 实现状态跟踪

### 5.1. 已实现功能 ✅

**基础环境配置:**
- [x] **FR-1**: Ganache区块链环境 - 已实现CLI和桌面端两种方式
  - **实现差异**: 增加了自动化CLI方式 (`npm run start-chain`)，提供比原计划更好的开发体验
  - **助记词更新**: 使用有效BIP39助记词 `bulk tonight audit hover toddler orange boost twenty biology flower govern soldier`
- [x] **FR-2a**: 网络基础活跃度 - Ganache 5秒自动出块已配置
- [x] **FR-2b**: 业务活跃度 - Manager账户余额变化展示 ✅
- [x] **预备资产部署**: 所有AI模型文件和数据已整理到 `backend/assets/` 目录

**开发环境:**
- [x] FastAPI后端框架已初始化 (`backend/main.py`, `backend/config.py`)
- [x] Vue前端项目结构已创建
- [x] 完整测试框架已建立 (`test/` 目录)
- [x] **非功能需求-一键启动**: 已实现 `./start-dev.sh` 自动化启动脚本

**配置管理:**
- [x] 确定性账户地址配置 (Manager_0-2, Treasury账户)
- [x] 威胁检测置信度阈值配置 (config.py)
- [x] Web3连接配置准备

**AI威胁检测:**
- [x] **FR-3**: AI模型加载和初始化 ✅
- [x] **FR-4**: 模拟攻击API和随机样本选择 ✅
- ⚠️ **AI模型预测准确性问题**: 发现模型架构重建不完整，导致权重加载失败，需要紧急修复
  - **现状**: 模型使用随机权重，所有攻击被误判为"Benign"
  - **根因**: training.ipynb中的完整Ensemble_Hybrid架构与model_loader.py中的简化版本不匹配
  - **影响**: 训练时99.62%准确率，部署时预测不准确
  - **修复计划**: Phase C专项修复，需要完整复制训练时的模型架构

**分级响应系统:**
- [x] **FR-5a-5d**: 完整的分级响应逻辑实现 ✅

**多签提案系统:**
- [x] **FR-6a-6b**: 自动和手动提案创建 ✅
- [x] **FR-7**: 提案查看和管理 ✅
- [x] **FR-8**: 2/3多重签名逻辑 ✅
- [x] **FR-9**: 激励机制和ETH转账 ✅

**模拟响应:**
- [x] **FR-10-11**: 数据库日志记录系统 ✅

**前端可视化:**
- [x] **FR-12**: 账户信息看板 ✅
- [x] **FR-12a**: 账户列表模拟功能 ✅ (增强为真实Web3账户创建)
- [x] **FR-13**: 威胁告警可视化 ✅
- [x] **FR-14**: 多签流程可视化 ✅
- [x] **FR-15**: 响应历史仪表盘 ✅
- [x] **FR-16**: 角色切换器 ✅

### 5.2. 第三阶段补充完成项 ✅

**界面国际化:**
- [x] **UI英文化**: 所有前端用户界面文本转换为英文 ✅
- [x] **组件文本更新**: AccountList, ProposalCard, ThreatAlert, LogDetailsModal, History组件英文化 ✅
- [x] **状态映射更新**: 所有状态、级别、操作类型的中英文映射 ✅
- [x] **错误信息英文化**: 所有alert和提示信息转换为英文 ✅

### 5.3. 第四阶段实现项 ✅ (自定义MultiSig智能合约)

**智能合约系统:**
- [x] **自定义MultiSig合约**: 开发并部署 `MultiSigProposal.sol` 智能合约 ✅
  - 2/3多重签名阈值
  - 自动执行机制
  - ETH奖励系统集成
  - 完整事件日志
- [x] **Python集成模块**: `multisig_contract.py` 实现后端与合约交互 ✅
- [x] **合约部署配置**: `multisig_contract.json` 存储合约地址和配置 ✅
- [x] **提案创建升级**: AI检测自动创建链上MultiSig提案 ✅
- [x] **签名流程优化**: Manager签名直接与智能合约交互 ✅
- [x] **奖励自动化**: 合约自动发送ETH奖励给最终签名者 ✅

**现在系统使用真正的智能合约进行多重签名管理！**
- 合约地址: `0x5FbDB2315678afecb367f032d93F642f64180aa3`
- 所有提案创建和签名都通过智能合约处理
- 自动ETH奖励和链上审计日志

### 5.4. 新一代区块链增强计划 🚀

**Phase 7: 奖金池机制升级 ✅ (Phase A完成)**
- [x] **激励机制重构**: 解决当前"最终签名者获奖"的博弈问题 ✅
- [x] **贡献度追踪**: 实现基于签名次数、响应时间、提案质量的综合评分 ✅
- [x] **奖金池管理**: 智能合约层面的奖金池充值、分配和管理 ✅
- [x] **自动分配机制**: 基于贡献度的提案执行时自动奖励分配 ✅

**Phase 8: 合约层角色权限分离 ✅ (完成)**
- [x] **智能合约角色系统**: 在合约层面直接定义Operator和Manager权限 ✅
- [x] **去中心化权限验证**: 移除后端权限判断，完全依赖合约验证 ✅
- [x] **角色管理功能**: 合约owner可动态添加/移除角色成员 ✅
- [x] **固定账户架构**: 整合原Phase 5的10账户结构设计 ✅

**Phase 9: API标准化和前端连接优化 ✅ (完成)**
- [x] **API响应标准化**: 统一所有API响应格式为 `{success, data, message, timestamp}` ✅
- [x] **请求验证强化**: 使用Pydantic模型进行完整的请求数据验证 ✅
- [x] **异常处理统一**: 实现层次化异常处理机制（业务、验证、系统异常等）✅
- [x] **API版本控制**: 所有端点添加 `/api/v1/` 版本前缀 ✅
- [x] **前端连接修复**: 解决API路径重复和数据映射问题 ✅
- [x] **启动脚本优化**: 修复system.sh中的状态检测逻辑 ✅

**Phase 10: 网络可视化和动态节点管理 ✅ (已完成)**
- [x] **网络拓扑可视化**: 类似区块链模拟器的交互式网络可视化页面 ✅
- [x] **多布局支持**: Star、Grid、Circle、Random四种网络布局模式 ✅
- [x] **节点详情系统**: 点击节点查看详细信息（地址、余额、角色、活动记录）✅
- [x] **真实节点创建**: 通过前端界面创建真实的Ganache账户节点 ✅
- [x] **安全节点删除**: 保护核心节点，支持非核心节点删除和余额回收 ✅
- [x] **实时网络更新**: 创建/删除节点后网络可视化自动更新 ✅
- [x] **攻击流程可视化**: 展示威胁检测→提案创建→签名→执行的完整流程 ✅
- [x] **Canvas渲染优化**: 使用HTML5 Canvas实现高性能网络渲染 ✅

**Phase C: AI模型预测准确性修复 ⚠️ (紧急修复)**
- [x] **问题诊断**: 模型训练99.62%准确率，但部署时预测不准确
- [x] **根因分析**: 模型架构重建不完整，权重加载失败
- [x] **前端修复**: 修复威胁类型显示问题，显示真实攻击类型
- [ ] **架构完整性**: 复制training.ipynb中的完整Ensemble_Hybrid架构
- [ ] **权重加载**: 修复state_dict键名匹配和权重加载验证
- [ ] **预测验证**: 创建准确性测试，确保模型能正确预测各种攻击类型

**后续扩展计划 (可选):**

**Phase 11: MetaMask Web3集成 (未实施)**
- [ ] **钱包连接集成**: 用户通过MetaMask直接控制私钥和交易
- [ ] **去中心化交互**: 前端直接与智能合约交互，移除后端代理
- [ ] **用户责任机制**: 每个链上操作需要用户明确授权和签名
- [ ] **兼容性保障**: 提供传统模式回退和无缝迁移方案

**数据同步机制评估:**
- [x] **现状分析**: 当前使用5秒轮询机制，适合演示原型系统 ✅
- [x] **WebSocket评估**: 基于系统规模和用户量，确定不需要实时推送 ✅
- [x] **性能优化**: 保持简单可靠的轮询机制，避免过度工程化 ✅

### 5.5. 实现方式改进

**相比原需求的改进:**
1. **增强的启动方式**: 提供CLI自动化、一键脚本、桌面端三种选择
2. **完善的测试框架**: 超出原计划，增加了完整的验证体系
3. **更好的项目结构**: 模块化目录设计，清晰的配置管理
4. **开发工具优化**: 自动化脚本和npm命令简化开发流程

**技术栈确认:**
- ✅ Ganache (CLI + 桌面端)
- ✅ FastAPI + Python
- ✅ Vue.js (框架准备)
- ✅ Web3.py (配置准备)
- ✅ SQLite (数据库配置)
- ✅ 确定性账户管理
